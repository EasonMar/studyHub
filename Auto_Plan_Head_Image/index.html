<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>计划书独立模板上传</title>
    <link rel="stylesheet" type="text/css" href="https://assets.xrkcdn.com/framework/css/reset-1.0.0.css">
    <link rel="stylesheet" type="text/css" href="../css/headStyle.css">
</head>

<body>
    <div class="con">
        <li style="background:#f9f9f9;font-weight:bold">
            <span class="code">独立模板名称 <mark style="color: red;font-size: 16px">| 避免中文</mark></span>
            <span class="name">产品中文名</span>
            <span class="com">所属公司</span>
            <span class="listcolor">#backColor</span>
            <span class="listcolor">#otherColor</span>
            <span class="show">独立模板图片.jpg</span>
            <span class="edit">编辑按钮区域</span>
        </li>
        <form class="result" action="/ued/auto/upload" enctype="multipart/form-data" method="post">
            <input type="text" name="css" hidden="hidden" id="css">
            <!-- edit -->
            <li class="data_head" data_head="">
                <span class="code"><input type="text" name="code" class="head_code" placeholder="例：kangyirensheng"></span>
                <span class="name"><input type="text" name="name" class="head_name" placeholder="例：泰康康逸人生保障计划"></span>
                <span class="com"><input type="text" name="com" class="head_company" placeholder="例：泰康"></span>
                <span class="listcolor backColor"><input type="text" name="backColor" class="head_backColor" placeholder="例：7eae3e"></span>
                <span class="listcolor otherColor"><input type="text" name="otherColor" class="head_otherColor" placeholder="例：246244"></span>
                <span class="show"><input type="file" accept="image/jpg" name="show" multiple="multiple"></span>
                <span class="edit">
                    <div class="confirm btn">确认</div>
                    <div class="editBtn btn">修改</div>
                    <div class="delBtn btn">删除</div>
                </span>
            </li>
            <!-- 点击确认后的html -->
            <!-- <li class="data_head" data_head="">
                <span class="code">pinganfu</span>
                <span class="name listcontent">平安福健康保障计划(2015)</span>
                <span class="com">平安</span>
                <span class="listcolor"><span class="cValue">#E2432E</span><i style="background:#e2432e"></i></span>
                <span class="listcolor"><span class="cValue">#CE1836</span><i style="background:#ce1836"></i></span>
                <span class="show">
                    <img src="E:\Desktop\工作截图\vue需要.png" class="preview" data-back="#e2432e" data-other="#ce1836">
                </span>
                <span class="edit">
                    <div class="confirm btn">确认</div>
                    <div class="editBtn btn">编辑</div>
                    <div class="delBtn btn">删除</div>
                </span>
            </li> -->
        </form>
        <div class="edit_total">
            <div class="new btn">新 增</div>
            <div class="upload btn">上 传</div>
            <div class="search btn">查 询</div>
        </div>
    </div>
</body>
<script src="https://assets.xrkcdn.com/xrk_c_base/js/jquery.js"></script>
<script src="https://assets.xrkcdn.com/framework/js/layout-1.0.0.js"></script>
<script src="../js/pinyin_dict_firstletter.js"></script>
<script src="../js/pinyinUtil.js"></script>
<script type="text/javascript">
// css_demo
var css_demo = ".Show .style-className{background:#backColor}.Show .style-className .color_bg,.Show .style-className .top-color{background:#otherColor}.Show .style-className .color{color:#otherColor}.Show .style-className .bdcolor{border-color:#otherColor}.Show .style-className header{background:url(https://bxr.im/events/html/ui/v/static/header/head_className.jpg) center top no-repeat;background-size:100%}";

// ================== 编辑逻辑 =========================

// 编辑栏信息【确认】
$('.result').on('click', '.confirm', function() {
    if ($(this).hasClass('complete')) return false; // 如果已经确认了,就不作处理.
    
    let _li = $(this).closest('li');

    // 各输入项的表单-input
    let head_code = _li.find('.head_code');
    let head_name = _li.find('.head_name');
    let head_company = _li.find('.head_company');
    let head_backColor = _li.find('.head_backColor');
    let head_otherColor = _li.find('.head_otherColor');

    // 从input中把独立模板信息保存到_data里
    let _data = {};
    _data.code = trimStr(head_code.val());
    _data.name = trimStr(head_name.val());
    _data.company = trimStr(head_company.val());
    _data.comshort = getFirstLetter(_data.company); // 添加公司简写字段.
    _data.backColor = trimStr(head_backColor.val());
    _data.otherColor = trimStr(head_otherColor.val());
    _data.imageVer = 0;  // 新建独立模板,其图片版本都是0
    console.log(_data);

    // 判断图片是否为空
    if (_li.find('[type=file]').val()) {
        _data.image = getFileUrl(_li.find('[type=file]')[0]);
    } else {
        _data.image = '';
    }

    // 判断信息是否完整
    if (!_data.code || !_data.name || !_data.company || !_data.backColor || !_data.otherColor || !_data.image) {
        theme.tips({
            "word": "<span style='font-size:26px'>信息未填写完整！</span>",
            "ok_word": "<span style='font-size:22px;color:red'>去确认</span>",
            "ok": () => null
        });
        return false;
    }

   

    // 保存独立模板的信息
    let jsonData = JSON.stringify(_data);
    _li.attr('data_head', jsonData);
    console.log(jsonData);

    // 把该列的独立模板信息都放进input.head_code的value里面(剔除image信息)
    let dotIndex = jsonData.lastIndexOf(',');
    head_code.val(jsonData.substring(0,dotIndex) + '}');
    console.log(head_code.val());

    // 确认后使表格变为不可不编辑状态....保留input.head_code供数据上传,将其隐藏.
    _li.find('.code').append(_data.code);
    _li.find('.name').html(_data.name);
    _li.find('.com').html(_data.company);
    _li.find('.backColor').html('<span class="cValue">#' + _data.backColor.toUpperCase() +
        '</span><i style="background:#' + _data.backColor.toLowerCase() + '">');
    _li.find('.otherColor').html('<span class="cValue">#' + _data.otherColor.toUpperCase() +
        '</span><i style="background:#' + _data.otherColor.toLowerCase() + '">');
    _li.find('.show').append('<img src="' + _data.image + '" class="preview" data-back="#' + _data.backColor.toLowerCase() + '" data-other="#' + _data.otherColor + '">');

    // 表示数据填写完成
    $(this).addClass('complete');

    // 把code值添加到file和code的name属性中,同时隐藏表单.
    _li.find('[type=file]').attr('name', _data.code).addClass('none');
    head_code.attr('name',_data.code).addClass('none');

    // head_name.attr('name',_data.code+'_name').addClass('none');
    // head_company.attr('name',_data.code+'_company').addClass('none');
    // head_backColor.attr('name',_data.code+'_backColor').addClass('none');
    // head_otherColor.attr('name',_data.code+'_otherColor').addClass('none');
});


// 【编辑】信息
$('.result').on('click', '.editBtn', function() {
    var _li = $(this).closest('li');
    // 如果表格没有complete,则不进行处理.
    if (_li.find('.complete').length == 0) return false;

    // 表示数据填写未完成.
    _li.find('.complete').removeClass('complete');

    // 拿取之前保存的数据
    var _data = JSON.parse(_li.attr('data_head'));

    // 渲染回编辑模式 --- 重新洗掉之前的痕迹,新建input.
    _li.find('.code').html('<input type="text" name="code" value="' + _data.code + '" class="head_code">');
    _li.find('.name').html('<input type="text" name="name" value="' + _data.name + '" class="head_name">');
    _li.find('.com').html('<input type="text" name="com" value="' + _data.company + '" class="head_company">');
    _li.find('.backColor').html('<input type="text" name="backColor" value="' + _data.backColor + '" class="head_backColor">');
    _li.find('.otherColor').html('<input type="text" name="otherColor" value="' + _data.otherColor + '" class="head_otherColor">');
    _li.find('.show').find('.preview').remove();
    _li.find('.show').find('[type=file]').removeClass('none');
});

// 【删除】该独立模板信息
$('.result').on('click', '.delBtn', function() {
    $(this).closest('li').remove();
});

// 独立模板代码检验：独立模板代码不能存在中文 + 控制输入的独立模板代码不重复(范围：页面内+数据库).
$('.result').on('change', '[name=code]', function() {
    var $this = $(this);
    var _code = trimStr($this.val());
    // 值为空时不处理
    if (!_code) return false;

    // 判断独立模板代码是否存在中文
    if(checkCN(_code)){
        theme.tips({
            "word": "<span style='font-size:26px'>独立模板代码不能含有中文</span>",
            "ok_word": "<span style='font-size:22px;color:red'>重新输入</span>",
            "ok": () => $this.val('').focus()
        });
        return false;
    }

    // 判断其他输入框的code值
    var _lis = $this.closest('li').siblings();

    for (let i = 0; i < _lis.length; i++) {
        let _val = $(_lis[i]).find('[name=code]').val();
        if (_val == _code) {
            theme.tips({
                "word": "<span style='font-size:26px'>此独立模板代码已经存在！</span>",
                "ok_word": "<span style='font-size:22px;color:red'>重新输入</span>",
                "ok": () => $this.val('').focus()
            });
            return false;
        }
    }

    // 判断code值在数据库内是否存在
    // has_code(_code,$this);
});

// 十六进制颜色值检验
$('.result').on('change', '[name=backColor],[name=otherColor]', function(){
    var $this = $(this);
    var color = trimStr($this.val());
    // 值为空时不处理
    if (!color) return false;

    if(!checkColor(color)){
        theme.tips({
            "word": "<span style='font-size:26px'>十六进制颜色值格式错误</span>",
            "ok_word": "<span style='font-size:22px;color:red'>重新输入</span>",
            "ok": () => $this.val('').focus()
        });
        return false;
    }
});

// 控制上传独立模板的格式
$('.result').on('change', '[type=file]', function() {
    var $this = $(this);
    var val = $this.val();
    // 值为空时不处理
    if (!val) return false;

    var ext = val.substring(val.lastIndexOf('.'));
    // 判断后缀.
    if (ext.indexOf('.jpg') == -1) {
        theme.tips({
            "title": "格式错误",
            "word": "<span style='font-size:26px'>图片的格式应为.jpg</span>",
            "ok_word": "<span style='font-size:24px;color:red'>更改图片</span>",
            "ok": () => $this.click()
        })
    }
});

/**
 * 底部按钮
 */
// 【新增】编辑栏
$('.new').click(function() {
    var _html = ['<li class="data_head" data_head="">',
                '    <span class="code"><input type="text" name="code" class="head_code" placeholder="例：kangyirensheng"></span>',
                '    <span class="name"><input type="text" name="name" class="head_name" placeholder="例：泰康康逸人生保障计划"></span>',
                '    <span class="com"><input type="text" name="com" class="head_company" placeholder="例：泰康"></span>',
                '    <span class="listcolor backColor"><input type="text" name="backColor" class="head_backColor" placeholder="例：7eae3e"></span>',
                '    <span class="listcolor otherColor"><input type="text" name="otherColor" class="head_otherColor" placeholder="例：246244"></span>',
                '    <span class="show"><input type="file" accept="image/jpg" name="show" multiple="multiple"></span>',
                '    <span class="edit">',
                '        <div class="confirm btn">确认</div>',
                '        <div class="editBtn btn">修改</div>',
                '        <div class="delBtn btn">删除</div>',
                '    </span>',
                '</li>'].join("");
    $('.result').append(_html);
});

// 【上传】按钮 -- 处理新增的样式表内容、css代码
// 最终上传前,要rebuild基准样式表HCS/head.css,为了保证上传之前已经rebuild完,这里使用了异步操作函数async
$('.upload').click(async function() {

    // 不存在独立模板信息.
    if (!$('.data_head').length ){
        theme.tips({
            "word": "<span style='font-size:26px'>没有可以上传的独立模板信息</span>",
            "ok_word": "<span style='font-size:22px;color:red'>去确认</span>",
            "ok": () => null
        });
        return false;
    }

    // 独立模板信息没有完全确认
    if ($('.data_head').length > $('.complete').length) {
        theme.tips({
            "word": "<span style='font-size:26px'>提交之前，需要完全确认好独立模板信息</span>",
            "ok_word": "<span style='font-size:22px;color:red'>去确认</span>",
            "ok": () => null
        });
        return false;
    }
    // 拼接css样式并放置到隐藏域中.
    compile_css();

    // rebuild基准样式表HCS/head.css
    let rebuild = await rebuild_css();
    if(rebuild) {
        $('form').submit();
    }else{
        theme.tips({
            "word": "<span style='font-size:26px'>rebuild基准样式表异常,请重新上传</span>",
            "ok_word": "<span style='font-size:22px;color:red'>OK</span>",
            "ok": () => null
        });
    }
});

// 跳到查询页面
$('.search').click(function() {
    window.location.href = '/ued/auto/uppage';
});

/**
 * 辅助函数
 */
// 判断输入的独立模板code在数据库内是否存在
function has_code(code,ipt) {
    var query = {code: code}
    $.lo_get('/ued/auto/hasCode',query,function(res){
        if(res.code){
            theme.tips({
                "word": "<span style='font-size:26px'>此独立模板代码已经存在！</span>",
                "ok_word": "<span style='font-size:22px;color:red'>重新输入</span>",
                "ok": () => ipt.val('').focus()
            });
        }else{
            return false;
        }
    });
}

// 字符串是否存在中文
function checkCN(str) {
    var reg = new RegExp(/[\u4e00-\u9fa5]/, 'g');
    return reg.test(str);
}

// 十六进制颜色值格式检测
function checkColor(color) {
    var simp = new RegExp(/^[0-9a-fA-F]{3}$/, 'g');
    var whole = new RegExp(/^[0-9a-fA-F]{6}$/, 'g');
    return simp.test(color) || whole.test(color)
}

// 拼接各独立模板css代码到隐藏域
function compile_css() {
    var _css = '';
    $('.data_head').each(function(i, v) {
        var tmpObj = JSON.parse($(v).attr('data_head'));
        _css += css_demo.replace(/className/g, tmpObj.code).replace(/otherColor/g, tmpObj.otherColor).replace(/backColor/g, tmpObj.backColor);
    });
    $('#css').val(_css);
}

// 去除首尾空格
var trimStr = (str) => str.replace(/(^\s*)|(\s*$)/g, "");

// 返回公司名简写
function getFirstLetter(words) {
    return pinyinUtil.getFirstLetter(words);
}

// rebuild基准样式表HCS/head.css
function rebuild_css(){
    return new Promise((resolve)=>{
        $.lo_get('/ued/auto/create',function(res){
            if(res.code == 200){
                resolve(true)
            }else{
                resolve(false)
            }
        }) 
    });   
}


/**
 * 获取图片码-供显示用.
 */

// 方案一 获取input[file]图片的url Important (其实并未获得真是路径,只是拿到可显示的图片编码)
function getFileUrl(file) {
    var url;
    // var file = Id(fileId);
    var agent = navigator.userAgent;
    if (agent.indexOf("MSIE") >= 1) {
        url = file.value;
    } else {
        url = window.URL.createObjectURL(file.files.item(0));
    }
    return url;
}

// =========== 展示部分 ==============
// 鼠标悬停独立模板显示大图
$('.con').on('mouseover', '.preview', function() {
    $(this).addClass('active');
    var img = '<div id="preview"><img src="' + this.src + '"></div>';
    $('body').append(img);
});
$('.con').on('mouseout', '.preview', function() {
    $(this).removeClass('active');
    $('#preview').remove();
});


// 点击独立模板预览demmo
$('.con').on('click', '.preview', function() {
    var demo = ['<div id="demo">',
        '        <div class="phone">',
        '            <div class="back">',
        '                <img src="' + this.src + '">',
        '                <div class="info">',
        '                    <div class="info-head">男 30岁</div>',
        '                    <ul class="info-list">',
        '                        <li>',
        '                            <p class="title">保障期限</p>',
        '                            <p class="content color"><span>终身</span></p>',
        '                        </li>',
        '                        <li>',
        '                            <p class="title">缴费期限</p>',
        '                            <p class="content color">',
        '                                <span>20</span>年交',
        '                            </p>',
        '                        </li>',
        '                        <li>',
        '                            <p class="title">保障额度</p>',
        '                            <p class="content color">',
        '                                <span>20</span>万元',
        '                            </p>',
        '                        </li>',
        '                        <li>',
        '                            <p class="title">',
        '                                首年缴费',
        '                            </p>',
        '                            <p class="content color">',
        '                                <span>7620</span>元',
        '                            </p>',
        '                        </li>',
        '                    </ul>',
        '                    <div class="info-arrow">',
        '                        <div class="info-arrow-bg color_bg"></div>',
        '                    </div>',
        '                </div>',
        '                <div class="normal-box jiankang">',
        '                    <div class="title">',
        '                        <p class="title-main">保障详情</p>',
        '                        <div class="bottom-line"></div>',
        '                        <span class="pingan-diseases-mark" data-diseases-id="28487346" data-diseases-scope="jiankang"><strong class="color_bg"></strong><em class="color">病种</em></span>',
        '                    </div>',
        '                    <div class="list">',
        '                        <div class="item">',
        '                            <div class="inner-hyperTitle">',
        '                                重疾金',
        '                            </div>',
        '                            <div class="inner-title no-after"><span class="color_bg point"></span> 20种特疾保障：不低于&nbsp;',
        '                                <span class="color bold">4万元</span>&nbsp;',
        '                            </div>',
        '                            <div class="inner-title "><span class="color_bg point"></span> 88种重疾保障：不低于&nbsp;',
        '                                <span class="color bold">20万元</span>&nbsp;',
        '                            </div>',
        '                            <div class="inner-list">',
        '                                <p>等待期180天后确诊即给付，为治疗争取时间</p>',
        '                            </div>',
        '                        </div>',
        '                        <div class="item">',
        '                            <div class="inner-hyperTitle">',
        '                                身价金',
        '                            </div>',
        '                            <div class="inner-title "><span class="color_bg point"></span> 终身保障金：不低于&nbsp;',
        '                                <span class="color bold">20万元</span>&nbsp;',
        '                            </div>',
        '                            <div class="inner-list">',
        '                                <p>高额身价保障，为家人一生遮风挡雨</p>',
        '                            </div>',
        '                        </div>',
        '                    </div>',
        '                </div>',
        '                <div class="is_author">',
        '                   <div id="float-container" class="float-container backFloat">',
        '                       <a class="care top-color" href="javascript:;">感兴趣</a>',
        '                   </div>',
        '                </div>',
        '            </div>',
        '        </div>',
        '    </div>'
    ].join("");

    $('body').append(demo);

    $('#demo').click(function() {
        $(this).remove()
    });

    $('#demo .back, #demo .backFloat').css('backgroundColor', $(this).data('back'));
    $('.top-color, .color_bg').css('backgroundColor', $(this).data('other'));
    $('.color').css('color', $(this).data('other'));

    // demo尺寸响应
    if (window.innerHeight < 850) {
        index = window.innerHeight / 850.0;
        $('#demo .phone').css('transform', 'scale(' + index.toFixed(4) + ') translateY(' + (window.innerHeight - 850) + 'px)')
    }
});
// demo尺寸响应
$(window).resize(function() {
    var index = 0;
    if (window.innerHeight < 850) {
        index = window.innerHeight / 850.0;
        $('#demo .phone').css('transform', 'scale(' + index.toFixed(4) + ') translateY(' + (window.innerHeight - 850) + 'px)')
    }
});
</script>

</html>